Okay, let's create a checklist of areas where `default_storage` is used directly and should potentially be replaced with the `SecureFileStorage` wrapper for consistency.

Based on our previous exploration and searches:

**Checklist for Standardizing on `SecureFileStorage`**

1.  **`apps/file_manager/storage.py` (`PathManager` class):**
    *   **Current State:** Uses `default_storage` directly for `listdir`, `size`, `url`, `exists`, `delete`, `save`, `open`. Also uses direct bucket access (`default_storage.bucket.objects.filter`) for deletion logic.
    *   **Action:** Modify `PathManager` to initialize with or accept a `SecureFileStorage` instance. Replace all calls to `default_storage` methods with calls to the `SecureFileStorage` instance's methods (`_save`, `_open`, `delete`, `exists`, `size`, `url`).
    *   **Considerations:**
        *   Determine the appropriate `private` setting (likely `True` for user files) and potentially a `collection` name (e.g., `'user_files'`) when initializing `SecureFileStorage` within or for `PathManager`.
        *   Carefully refactor the `_delete_directory` and `_delete_file` methods. Direct bucket access (`bucket.objects.filter`) might need to be adapted (e.g., accessing `secure_storage.storage.bucket...`) or replaced with standard storage API calls if feasible.

2.  **`apps/file_manager/views.py`:**
    *   **Current State:** Imports `default_storage`. Uses it directly in `convert_csv_to_text` (`default_storage.open`) and for verification in `upload_file` (`default_storage.exists`). Primarily interacts via `PathManager`.
    *   **Action:** Ensure all interactions happen through the updated `PathManager`. Replace the direct `default_storage.open` in `convert_csv_to_text` with a call via the appropriate storage instance (likely through `PathManager`). Re-evaluate the verification step in `upload_file` - it might become redundant if `PathManager.save_file` handles verification.

3.  **`apps/agents/tools/screenshot_tool/screenshot_tool.py`:**
    *   **Current State:** Uses `default_storage` directly for `save`, `url`, and `exists`.
    *   **Action:** Instantiate `SecureFileStorage` (e.g., `screenshot_storage = SecureFileStorage(private=True, collection='screenshots')`). Replace direct `default_storage` calls with calls to `screenshot_storage`.

4.  **`apps/agents/tools/crawl_website_tool/utils.py`:**
    *   **Current State:** Uses `default_storage.url`, `default_storage.get_modified_time`, and direct bucket access (`default_storage.bucket.objects.filter`) in `get_crawl_results`.
    *   **Action:** Instantiate `SecureFileStorage` (likely mirroring the settings used in `apps/crawl_website/views.py`: `private=True`, `collection=''`). Replace standard API calls (`url`, `get_modified_time`).
    *   **Considerations:** The `get_crawl_results` function needs careful review due to direct bucket access. Adapt it to use the underlying storage object accessed *via* the `SecureFileStorage` wrapper (`secure_storage.storage.bucket...`) or find an alternative approach using standard methods if possible.

5.  **`apps/seo_manager/sitemap_extractor.py`:**
    *   **Current State:** Uses `default_storage.save`.
    *   **Action:** Instantiate `SecureFileStorage` (e.g., `meta_storage = SecureFileStorage(private=True, collection='meta-tags')`). Replace `default_storage.save` with `meta_storage._save`.

6.  **`apps/seo_manager/views/meta_tags_views.py`:**
    *   **Current State:** Uses `default_storage.listdir`.
    *   **Action:** Use the same `SecureFileStorage` instance as in `sitemap_extractor.py` (or instantiate similarly). Replace `default_storage.listdir` with `meta_storage.storage.listdir` (accessing the underlying storage for `listdir` as `SecureFileStorage` itself doesn't seem to wrap `listdir` directly, only its components like `exists`, `url`, etc. *Correction:* `SecureFileStorage` *does* wrap the main methods, but `listdir` is often needed to iterate, which might still require accessing the base storage if `SecureFileStorage` doesn't provide a direct `listdir`). Let's verify `SecureFileStorage` implementation again if needed. *Self-correction:* Looking back at `core/storage.py`, `SecureFileStorage` *doesn't* have a `listdir` method. So, accessing the underlying storage via `secure_storage.storage.listdir()` would be necessary here.

**Areas NOT to Change:**

*   **`core/views.py` (`serve_protected_file`):** This view *must* use `default_storage` because it's the endpoint that serves files whose URLs are generated by `SecureFileStorage(private=True).url()`. It needs access to the actual underlying storage to retrieve the file content.
*   **`core/minio_storage.py`:** This is the underlying storage implementation used *by* `default_storage` (and thus by `SecureFileStorage`). It should not be changed to use `SecureFileStorage`.

This checklist provides a roadmap. Each point, especially those involving direct bucket access or `listdir`, will require careful implementation and testing. Would you like to start implementing these changes, perhaps beginning with the `apps/file_manager`?
