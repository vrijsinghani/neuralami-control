{% extends "layouts/base.html" %}
{% load static %}
{% block title %} Website Crawler {% endblock %}

<!-- Specific Page CSS goes HERE  -->
{% block extrastyle %}
<style>
    /* Card styling */
    .info-card {
        border-radius: 10px;
        height: 100%;
        transition: transform 0.3s ease;
    }

    .info-card:hover {
        transform: translateY(-5px);
    }

    .info-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 1rem;
    }

    /* Progress bar styling */
    .progress {
        height: 8px;
        overflow: visible;
    }

    .progress .progress-bar {
        position: relative;
        overflow: visible;
        border-radius: 8px;
    }

    .progress-percentage {
        position: absolute;
        right: 0;
        top: -25px;
    }

    /* Stats cards */
    .stat-card {
        border-radius: 10px;
        padding: 1.5rem;
        position: relative;
        overflow: hidden;
        min-height: 120px;
    }

    .stat-icon {
        position: absolute;
        right: 1rem;
        top: 50%;
        transform: translateY(-50%);
        opacity: 0.8;
    }

    /* Tip banner */
    .tip-banner {
        border-left: 4px solid var(--bs-warning);
        background-color: rgba(225, 192, 142, 0.1);
    }

    /* URL validation message */
    .url-validation {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        border-radius: 4px;
        display: inline-block;
        margin-top: 0.25rem;
    }

    /* Crawling in progress spinner */
    .crawling-spinner {
        display: inline-block;
        width: 1.5rem;
        height: 1.5rem;
        vertical-align: middle;
        border: 0.2em solid currentColor;
        border-right-color: transparent;
        border-radius: 50%;
        animation: spinner-border .75s linear infinite;
    }

    /* Page details section */
    .page-details {
        border-top: 1px solid rgba(0,0,0,0.1);
        padding-top: 1rem;
        margin-top: 1rem;
    }

    /* Dark mode adjustments */
    .dark-version .info-card {
        background-color: #1a2035;
    }

    .dark-version .tip-banner {
        background-color: rgba(225, 192, 142, 0.05);
    }
</style>
{% endblock extrastyle %}

{% block content %}
<div class="container-fluid py-4"
     id="crawl-container"
     hx-ext="ws">

    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body p-3">
                    <div class="row">
                        <div class="col-md-8">
                            <h5 class="mb-0">Website Crawler</h5>
                            <p class="text-sm mb-0">Enter a URL to crawl and analyze website content</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Active Crawls Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header p-3 d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Active Crawls</h6>
                    <button class="btn btn-sm btn-info"
                            hx-get="{% url 'crawl_website:list_active_crawls' %}"
                            hx-target="#active-crawls-container"
                            hx-trigger="click"
                            hx-indicator=".htmx-indicator">
                        <i class="fas fa-sync-alt"></i> Refresh
                        <span class="htmx-indicator spinner-border spinner-border-sm" style="display: none;"></span>
                    </button>
                </div>
                <div class="card-body p-3">
                    <div id="active-crawls-container"
                         hx-get="{% url 'crawl_website:list_active_crawls' %}"
                         hx-trigger="load">
                        <p class="text-muted">Loading active crawls...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Input Form Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body p-3">
                    <form id="crawl-form"
                          hx-post="{% url 'crawl_website:initiate_crawl' %}"
                          hx-target="#crawl-status-progress"
                          hx-swap="innerHTML"
                          hx-indicator="#processing-indicator"
                          hx-on::after-request="
                            const taskId = event.detail.xhr.getResponseHeader('X-Task-ID');
                            if (taskId) {
                                // Reset UI state for new crawl
                                // Reset all progress elements
                                resetCrawlProgress();

                                // Show the progress spinner
                                const spinner = document.getElementById('progress-spinner');
                                if (spinner) spinner.style.display = 'block';

                                // Update the status title
                                const statusTitle = document.getElementById('crawling-status-title');
                                if (statusTitle) statusTitle.textContent = 'Crawling in Progress';

                                // Show the cancel button
                                const cancelButton = document.getElementById('cancel-crawl-btn');
                                if (cancelButton) cancelButton.style.display = 'inline-block';

                                // Show progress section
                                document.getElementById('crawling-progress-section').style.display = 'block';

                                // Set up WebSocket connection
                                const wsScheme = window.location.protocol === 'https:' ? 'wss' : 'ws';
                                const wsPath = `${wsScheme}://${window.location.host}/ws/crawl/${taskId}/`;

                                // Disconnect any existing WebSocket connection
                                const container = document.getElementById('crawl-container');
                                if (container.getAttribute('ws-connect')) {
                                    htmx.trigger(container, 'htmx:wsClose');
                                }

                                // Set up new WebSocket connection
                                container.setAttribute('ws-connect', wsPath);
                                htmx.process(container);

                                // Store task ID in a data attribute for later use
                                container.setAttribute('data-task-id', taskId);
                            }
                          ">
                        {% csrf_token %}

                        <div class="row">
                            <div class="col-md-8">
                                <label for="url" class="form-label">Website URL to Crawl
                                    <i class="fas fa-info-circle text-info ms-1" data-bs-toggle="tooltip" data-bs-placement="top"
                                       title="Specify the base URL where the crawl will begin. Ensure the URL is valid, includes the protocol (http:// or https://), and points to the desired starting page."></i>
                                </label>
                                <input type="url"
                                       class="form-control"
                                       id="url"
                                       name="url"
                                       placeholder="https://example.com"
                                       required
                                       hx-get="#"
                                       hx-trigger="keyup changed delay:500ms"
                                       hx-swap="none"
                                       _="on keyup
                                          if my.value.trim() !== '' and not my.value.match('^https?://.*\..*')
                                            set #url-validation.textContent to 'Please enter a valid URL (e.g., https://example.com)'
                                            remove .d-none from #url-validation
                                            remove .bg-success from #url-validation
                                            add .bg-danger .text-white to #url-validation
                                          else if my.value.trim() !== ''
                                            set #url-validation.textContent to 'Valid URL format'
                                            remove .d-none from #url-validation
                                            remove .bg-danger from #url-validation
                                            add .bg-success .text-white to #url-validation
                                          else
                                            add .d-none to #url-validation
                                          end">
                                <div id="url-validation" class="url-validation d-none"></div>
                            </div>
                            <div class="col-md-4">
                                <label for="max-depth" class="form-label">Crawl Depth
                                    <i class="fas fa-info-circle text-info ms-1" data-bs-toggle="tooltip" data-bs-placement="top"
                                       title="Define the depth of the crawl: Level 1: Crawl only the starting page. Level 2: Crawl the starting page and all links found on it. Higher levels recursively follow links on each page, exponentially increasing the number of pages crawled."></i>
                                </label>
                                <select class="form-control" id="max-depth" name="max_depth">
                                    <option value="1">Level 1 (Homepage Only)</option>
                                    <option value="2" selected>Level 2 (Pages + Links)</option>
                                    <option value="3">Level 3 (Deep Crawl)</option>
                                    <option value="4">Level 4 (Very Deep)</option>
                                </select>
                            </div>
                        </div>

                        <div class="mt-3 mb-3">
                            <button type="button"
                                    class="btn btn-sm btn-outline-primary"
                                    id="toggle-advanced-options"
                                    onclick="toggleAdvancedOptions()">
                                <i class="fas fa-cog me-1"></i> Show Advanced Options
                            </button>
                        </div>

                        <!-- Advanced Options (Collapsible) -->
                        <div id="advanced-options" class="mt-4 d-none">
                            <div class="card bg-gray-100 border-0 shadow-none">
                                <div class="card-body">
                                    <h6 class="mb-3">Advanced Crawl Options</h6>

                                    <!-- Crawl Mode Selection -->
                                    <div class="mb-3">
                                        <label class="form-label">Crawl Mode
                                            <i class="fas fa-info-circle text-info ms-1" data-bs-toggle="tooltip" data-bs-placement="top"
                                               title="Choose between automatic, discovery-based, or sitemap-based crawling."></i>
                                        </label>
                                        <div class="form-check">
                                            <input class="form-check-input"
                                                   type="radio"
                                                   name="mode"
                                                   id="mode_auto"
                                                   value="auto"
                                                   checked
                                                   hx-get="#"
                                                   hx-trigger="change"
                                                   hx-swap="none"
                                                   _="on change
                                                      add .d-none to #sitemap-crawl-options
                                                      remove .d-none from #standard-crawl-options">
                                            <label class="form-check-label" for="mode_auto">
                                                Auto (Try sitemap first, then discovery)
                                                <i class="fas fa-info-circle text-info ms-1" data-bs-toggle="tooltip" data-bs-placement="top"
                                                   title="The crawler will first try to use the website's sitemap. If no sitemap is found, it will automatically fall back to discovery-based crawling. This is the recommended option for most websites."></i>
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input"
                                                   type="radio"
                                                   name="mode"
                                                   id="mode_discovery"
                                                   value="discovery"
                                                   hx-get="#"
                                                   hx-trigger="change"
                                                   hx-swap="none"
                                                   _="on change
                                                      add .d-none to #sitemap-crawl-options
                                                      remove .d-none from #standard-crawl-options">
                                            <label class="form-check-label" for="mode_discovery">
                                                Discovery (Follows links)
                                                <i class="fas fa-info-circle text-info ms-1" data-bs-toggle="tooltip" data-bs-placement="top"
                                                   title="The crawler will parse the HTML of each page to extract and follow links (anchor tags). This method is suitable for websites without a sitemap or for broader exploration."></i>
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input"
                                                   type="radio"
                                                   name="mode"
                                                   id="mode_sitemap"
                                                   value="sitemap"
                                                   hx-get="#"
                                                   hx-trigger="change"
                                                   hx-swap="none"
                                                   _="on change
                                                      add .d-none to #standard-crawl-options
                                                      remove .d-none from #sitemap-crawl-options">
                                            <label class="form-check-label" for="mode_sitemap">
                                                Sitemap-Based Crawl
                                                <i class="fas fa-info-circle text-info ms-1" data-bs-toggle="tooltip" data-bs-placement="top"
                                                   title="The crawler will fetch and parse the website's sitemap.xml file (if available) to identify pages for crawling. This method is faster and more structured but relies on the sitemap's accuracy and completeness."></i>
                                            </label>
                                        </div>
                                    </div>

                                    <!-- Standard Crawl Options -->
                                    <div id="standard-crawl-options">
                                        <div class="mb-3">
                                            <label for="max-pages" class="form-label">Maximum Pages
                                                <i class="fas fa-info-circle text-info ms-1" data-bs-toggle="tooltip" data-bs-placement="top"
                                                   title="Set an upper limit on the number of pages to crawl. This prevents excessive crawling and resource usage. For example, a value of '7' will stop the crawl after processing 7 pages, regardless of the total number of pages available."></i>
                                            </label>
                                            <input type="number" class="form-control" id="max-pages" name="max_pages" value="100" min="1">
                                        </div>
                                        <div class="mb-3">
                                            <label for="delay-seconds" class="form-label">Crawl Rate (seconds between requests)
                                                <i class="fas fa-info-circle text-info ms-1" data-bs-toggle="tooltip" data-bs-placement="top"
                                                   title="Set the delay between requests in seconds. A higher value means slower crawling but is more respectful to the target website. For example, a value of '2' will wait 2 seconds between requests."></i>
                                            </label>
                                            <input type="number" class="form-control" id="delay-seconds" name="delay_seconds" value="1.0" min="0.1" step="0.1">
                                        </div>
                                        <div class="mb-3">
                                            <label for="include-patterns" class="form-label">Include Patterns (Optional)
                                                <i class="fas fa-info-circle text-info ms-1" data-bs-toggle="tooltip" data-bs-placement="top"
                                                   title="Use glob patterns to specify which URLs to include in the crawl. For example: 'blog/*' matches all URLs under the 'blog' path. 'docs/*' matches all URLs under the 'docs' path. Patterns are case-sensitive and should align with the website's URL structure."></i>
                                            </label>
                                            <input type="text" class="form-control" id="include-patterns" name="include_patterns" placeholder="e.g., blog/*, docs/*">
                                            <small class="form-text text-muted">Comma-separated glob patterns</small>
                                        </div>
                                        <div class="mb-3">
                                            <label for="exclude-patterns" class="form-label">Exclude Patterns (Optional)
                                                <i class="fas fa-info-circle text-info ms-1" data-bs-toggle="tooltip" data-bs-placement="top"
                                                   title="Use glob patterns to exclude specific URLs from the crawl. For example: 'admin/*' excludes all URLs under the 'admin' path. 'login/*' excludes all URLs under the 'login' path. Patterns are case-sensitive and should be used to avoid unnecessary or restricted pages."></i>
                                            </label>
                                            <input type="text" class="form-control" id="exclude-patterns" name="exclude_patterns" placeholder="e.g., admin/*, login/*">
                                            <small class="form-text text-muted">Comma-separated glob patterns</small>
                                        </div>
                                    </div>

                                    <!-- Sitemap Crawl Options -->
                                    <div id="sitemap-crawl-options" class="d-none">
                                        <div class="mb-3">
                                            <label for="max-sitemap-urls" class="form-label">Max Sitemap URLs to Process</label>
                                            <input type="number" class="form-control" id="max-sitemap-urls" name="max_sitemap_urls" value="50" min="1">
                                        </div>
                                        <div class="mb-3">
                                            <label for="max-sitemap-retriever-pages" class="form-label">Max Sitemap Discovery Pages</label>
                                            <input type="number" class="form-control" id="max-sitemap-retriever-pages" name="max_sitemap_retriever_pages" value="1000" min="1">
                                        </div>
                                        <div class="mb-3">
                                            <label for="sitemap-requests-per-second" class="form-label">Requests per Second</label>
                                            <input type="number" class="form-control" id="sitemap-requests-per-second" name="sitemap_requests_per_second" value="5.0" step="0.1" min="0.1">
                                        </div>
                                        <div class="mb-3">
                                            <label for="sitemap-timeout" class="form-label">Timeout (ms)</label>
                                            <input type="number" class="form-control" id="sitemap-timeout" name="sitemap_timeout" value="15000" min="1000">
                                        </div>
                                    </div>

                                    <hr class="horizontal dark my-4">

                                    <!-- Common Options -->
                                    <h6 class="mb-3">Content Options</h6>

                                    <div class="mb-3">
                                        <label class="form-label">Output Format
                                            <i class="fas fa-info-circle text-info ms-1" data-bs-toggle="tooltip" data-bs-placement="top"
                                               title="Select the type of content you want to extract from each page. You can select multiple formats."></i>
                                        </label>
                                        <div class="form-check">
                                            <input class="form-check-input output-format-checkbox"
                                                   type="checkbox"
                                                   id="output-format-text"
                                                   name="output_format"
                                                   value="text"
                                                   checked
                                                   hx-get="#"
                                                   hx-trigger="change"
                                                   hx-swap="none"
                                                   _="on change
                                                      if #output-format-full.checked
                                                        set #output-format-full.checked to false
                                                      end">
                                            <label class="form-check-label" for="output-format-text">Text Content
                                                <i class="fas fa-info-circle text-info ms-1" data-bs-toggle="tooltip" data-bs-placement="top"
                                                   title="Extracts only the visible text content from the page, excluding HTML tags and other non-visible elements."></i>
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input output-format-checkbox"
                                                   type="checkbox"
                                                   id="output-format-html"
                                                   name="output_format"
                                                   value="html"
                                                   hx-get="#"
                                                   hx-trigger="change"
                                                   hx-swap="none"
                                                   _="on change if #output-format-full.checked set #output-format-full.checked to false">
                                            <label class="form-check-label" for="output-format-html">HTML
                                                <i class="fas fa-info-circle text-info ms-1" data-bs-toggle="tooltip" data-bs-placement="top"
                                                   title="Extracts the full HTML source code of the page, including all tags, attributes, and structure."></i>
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input output-format-checkbox"
                                                   type="checkbox"
                                                   id="output-format-links"
                                                   name="output_format"
                                                   value="links"
                                                   hx-get="#"
                                                   hx-trigger="change"
                                                   hx-swap="none"
                                                   _="on change if #output-format-full.checked set #output-format-full.checked to false">
                                            <label class="form-check-label" for="output-format-links">Links
                                                <i class="fas fa-info-circle text-info ms-1" data-bs-toggle="tooltip" data-bs-placement="top"
                                                   title="Extracts all hyperlinks (anchor tags) from the page, including internal and external URLs."></i>
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input output-format-checkbox"
                                                   type="checkbox"
                                                   id="output-format-metadata"
                                                   name="output_format"
                                                   value="metadata"
                                                   hx-get="#"
                                                   hx-trigger="change"
                                                   hx-swap="none"
                                                   _="on change if #output-format-full.checked set #output-format-full.checked to false">
                                            <label class="form-check-label" for="output-format-metadata">Metadata
                                                <i class="fas fa-info-circle text-info ms-1" data-bs-toggle="tooltip" data-bs-placement="top"
                                                   title="Extracts metadata from the page, such as <title>, <meta> tags (e.g., description, keywords), and other structured data."></i>
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input output-format-checkbox"
                                                   type="checkbox"
                                                   id="output-format-screenshot"
                                                   name="output_format"
                                                   value="screenshot"
                                                   hx-get="#"
                                                   hx-trigger="change"
                                                   hx-swap="none"
                                                   _="on change if #output-format-full.checked set #output-format-full.checked to false">
                                            <label class="form-check-label" for="output-format-screenshot">Screenshot
                                                <i class="fas fa-info-circle text-info ms-1" data-bs-toggle="tooltip" data-bs-placement="top"
                                                   title="Captures a screenshot of the rendered page as it would appear in a browser."></i>
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input"
                                                   type="checkbox"
                                                   id="output-format-full"
                                                   name="output_format"
                                                   value="full"
                                                   hx-get="#"
                                                   hx-trigger="change"
                                                   hx-swap="none"
                                                   _="on change
                                                      if I.checked
                                                        set .output-format-checkbox.checked to false
                                                        set .output-format-checkbox.disabled to true
                                                      else
                                                        set .output-format-checkbox.disabled to false
                                                        set #output-format-text.checked to true
                                                      end">
                                            <label class="form-check-label" for="output-format-full">Full (All formats)
                                                <i class="fas fa-info-circle text-info ms-1" data-bs-toggle="tooltip" data-bs-placement="top"
                                                   title="Extracts all available data, including text content, HTML, links, metadata, and screenshots. This is the most comprehensive option."></i>
                                            </label>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label for="css-selector" class="form-label">CSS Selector (Optional)
                                            <i class="fas fa-info-circle text-info ms-1" data-bs-toggle="tooltip" data-bs-placement="top"
                                               title="Specify a CSS selector to target specific elements on the page for scraping. For example: '.article-content' selects all elements with the class 'article-content'. '#main-content' selects the element with the ID 'main-content'. Leave blank to scrape the entire page. Use standard CSS selector syntax."></i>
                                        </label>
                                        <input type="text" class="form-control" id="css-selector" name="css-selector" placeholder="e.g., article.content">
                                    </div>

                                    <div class="mb-3">
                                        <label for="wait-for" class="form-label">Wait For Element (Optional)
                                            <i class="fas fa-info-circle text-info ms-1" data-bs-toggle="tooltip" data-bs-placement="top"
                                               title="Specify a CSS selector for an element the crawler should wait for before starting to scrape. This is useful for handling dynamic content that loads asynchronously (e.g., JavaScript-rendered pages). For example: '#main-content' waits for the element with ID 'main-content' to load before proceeding."></i>
                                        </label>
                                        <input type="text" class="form-control" id="wait-for" name="wait-for" placeholder="e.g., #main-content">
                                    </div>

                                    <div class="mb-3 form-check">
                                        <input type="checkbox" class="form-check-input" id="save-file" name="save-file" checked>
                                        <label class="form-check-label" for="save-file">Save result to file
                                            <i class="fas fa-info-circle text-info ms-1" data-bs-toggle="tooltip" data-bs-placement="top"
                                               title="Save the crawl results to a file for later reference or processing."></i>
                                        </label>
                                    </div>

                                    <div class="mb-3 form-check">
                                        <input type="checkbox" class="form-check-input" id="save-as-csv" name="save-as-csv" checked>
                                        <label class="form-check-label" for="save-as-csv">Save as CSV
                                            <i class="fas fa-info-circle text-info ms-1" data-bs-toggle="tooltip" data-bs-placement="top"
                                               title="Exports the scraped data to a CSV file, which can be easily imported into tools like Excel, Google Sheets, or data analysis software."></i>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="text-end mt-3">
                            <button type="submit"
                                    class="btn bg-gradient-primary"
                                    hx-disable-elt="this"
                                    _="on htmx:beforeRequest
                                         if not document.querySelector('input[name=\'output_format\']:checked')
                                           halt the event
                                           call Swal.fire({title: 'Error', text: 'Please select at least one output format', icon: 'error'})
                                         end">
                                <span class="indicator-label">
                                    <i class="fas fa-spider me-2"></i>Start Crawling
                                </span>
                                <span class="indicator-progress" id="processing-indicator" style="display: none;">
                                    Please wait...
                                    <span class="spinner-border spinner-border-sm align-middle ms-2"></span>
                                </span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Info Cards Section -->
    <div class="row mb-4">
        <div class="col-md-4 mb-4 mb-md-0">
            <div class="card info-card bg-gradient-light shadow-sm">
                <div class="card-body p-3">
                    <div class="d-flex">
                        <div class="info-icon bg-gradient-primary text-white">
                            <i class="fas fa-info"></i>
                        </div>
                        <div>
                            <h6 class="text-dark mb-1">What is crawling?</h6>
                            <p class="mb-0 text-sm">Our tool visits web pages like a visitor would, collecting useful information.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-4 mb-md-0">
            <div class="card info-card bg-gradient-light shadow-sm">
                <div class="card-body p-3">
                    <div class="d-flex">
                        <div class="info-icon bg-gradient-info text-white">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <div>
                            <h6 class="text-dark mb-1">Respectful Crawling</h6>
                            <p class="mb-0 text-sm">We follow robots.txt rules and don't overload servers.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card info-card bg-gradient-light shadow-sm">
                <div class="card-body p-3">
                    <div class="d-flex">
                        <div class="info-icon bg-gradient-success text-white">
                            <i class="fas fa-bolt"></i>
                        </div>
                        <div>
                            <h6 class="text-dark mb-1">Quick Results</h6>
                            <p class="mb-0 text-sm">Most crawls complete in under 2 minutes.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Crawling Progress Section -->
    <div class="row mb-4" id="crawling-progress-section" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header p-3">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <div class="crawling-spinner me-3" id="progress-spinner"></div>
                            <h6 class="mb-0" id="crawling-status-title">Crawling in Progress</h6>
                        </div>
                        <button id="cancel-crawl-btn" class="btn btn-sm btn-danger"
                                hx-target="#active-crawls-container"
                                hx-indicator=".htmx-indicator"
                                hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                                onclick="cancelCrawl()">
                            <i class="fas fa-stop-circle me-1"></i> Stop Crawl
                            <span class="htmx-indicator spinner-border spinner-border-sm" style="display: none;"></span>
                        </button>
                    </div>
                </div>
                <div class="card-body p-3">
                    <div id="crawl-status-progress">
                        {% include "crawl_website/partials/_crawl_status_progress.html" %}
                    </div>

                    <div class="row mt-4">
                        <div class="col-md-4 mb-4 mb-md-0">
                            <div class="card stat-card bg-gradient-white shadow-sm">
                                <div class="stat-icon">
                                    <i class="fas fa-file-alt fa-2x text-primary opacity-6"></i>
                                </div>
                                <h6 class="text-sm mb-1">Pages Visited</h6>
                                <h3 class="font-weight-bold mb-0" id="pages-visited-count">0</h3>
                            </div>
                        </div>
                        <div class="col-md-4 mb-4 mb-md-0">
                            <div class="card stat-card bg-gradient-white shadow-sm">
                                <div class="stat-icon">
                                    <i class="fas fa-link fa-2x text-info opacity-6"></i>
                                </div>
                                <h6 class="text-sm mb-1">Links Found</h6>
                                <h3 class="font-weight-bold mb-0" id="links-found-count">0</h3>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card stat-card bg-gradient-white shadow-sm">
                                <div class="stat-icon">
                                    <i class="fas fa-globe fa-2x text-success opacity-6"></i>
                                </div>
                                <h6 class="text-sm mb-1">Current Page</h6>
                                <p class="text-sm mb-0 text-truncate" id="current-page-url">Waiting for crawl to start...</p>
                            </div>
                        </div>
                    </div>

                    <div class="tip-banner p-3 mt-4">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-lightbulb text-warning me-2"></i>
                            <p class="mb-0 text-sm">Tip: While crawling, you can minimize this window. We'll notify you when it's complete!</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Crawl Results Section -->
    <div class="row" id="crawl-results-section" style="display: none;">
        <div class="col-12">
            <!-- This will be replaced via OOB swap with the _crawl_results_section.html partial -->
            <div class="card">
                <div class="card-header p-3">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            <h6 class="mb-0">Crawl Results</h6>
                        </div>
                        <button class="btn btn-sm btn-outline-primary"
                                hx-on:click="document.getElementById('crawl-results-section').style.display = 'none';">
                            <i class="fas fa-times me-1"></i> Close Results
                        </button>
                    </div>
                </div>
                <div class="card-body p-3">
                    <div id="crawl-results">
                        <p>Results will appear here once the crawl is complete.</p>
                    </div>

                    <div id="crawl-download-links" class="mt-3 d-flex gap-2" style="display: none;">
                        <!-- Download links will be added here -->
                    </div>

                    <div class="page-details" id="page-details-section" style="display: none;">
                        <h6 class="mb-3">Page Details</h6>
                        <div class="table-responsive">
                            <table class="table align-items-center mb-0">
                                <thead>
                                    <tr>
                                        <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">URL</th>
                                        <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Title</th>
                                        <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="page-details-table">
                                    <!-- Page details will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block extra_js %}
<script src="{% static 'assets/js/plugins/sweetalert.min.js' %}"></script>
<script src="{% static 'assets/js/plugins/ws.js' %}"></script>
<script src="{% static 'crawl_website/js/crawl-htmx.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        })
    });
</script>
{% endblock extra_js %}
