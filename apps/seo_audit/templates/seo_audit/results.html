{% extends "layouts/base.html" %}
{% load static %}

{% block title %} SEO Audit Results {% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Audit Summary Card -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header pb-0">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="mb-0">Audit Summary</h6>
                        </div>
                        <div class="col-md-6 text-end">
                            <a href="{% url 'seo_audit:export_audit' audit.id %}" class="btn btn-sm btn-primary">Export Results</a>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Website:</strong> {{ audit.website }}</p>
                            <p><strong>Start Time:</strong> {{ audit.start_time|date:"M d, Y H:i" }}</p>
                            <p><strong>Duration:</strong> {{ audit.duration|default:"In Progress" }} seconds</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Total Pages:</strong> {{ audit.results.summary.total_pages|default:"0" }}</p>
                            <p><strong>Total Issues:</strong> {{ audit.issues.count }}</p>
                            <p><strong>Status:</strong> {{ audit.get_status_display }}</p>
                            {% if audit.error %}
                                <p class="text-danger"><strong>Error:</strong> {{ audit.error }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row">
        <div class="col-xl-6">
            <div class="card mb-4">
                <div class="card-header pb-0">
                    <h6 class="mb-0">Issue Severity Distribution</h6>
                </div>
                <div class="card-body">
                    <div style="height: 300px;">
                        <canvas id="severityChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-6">
            <div class="card mb-4">
                <div class="card-header pb-0">
                    <h6 class="mb-0">Issue Type Distribution</h6>
                </div>
                <div class="card-body">
                    <canvas id="issueTypeChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Issues Table -->
    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-header pb-0">
                    <h6 class="mb-0">Issues Found</h6>
                </div>
                <div class="card-body px-0 pt-0 pb-2">
                    <div class="table-responsive p-0">
                        <table class="table align-items-center mb-0" id="issues-table">
                            <thead>
                                <tr>
                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Severity</th>
                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Type</th>
                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">URL</th>
                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Details</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for issue in audit.issues.all %}
                                <tr>
                                    <td class="text-sm">
                                        <span class="badge {% if issue.severity == 'critical' %}bg-danger{% elif issue.severity == 'high' %}bg-warning{% elif issue.severity == 'medium' %}bg-info{% else %}bg-success{% endif %}">
                                            {{ issue.get_severity_display }}
                                        </span>
                                    </td>
                                    <td class="text-sm">{{ issue.get_issue_type_display }}</td>
                                    <td class="text-sm">
                                        <a href="{{ issue.url }}" target="_blank" class="text-primary">
                                            {{ issue.url|truncatechars:50 }}
                                        </a>
                                    </td>
                                    <td class="text-sm">
                                        <div>
                                            <strong>Issue:</strong> 
                                            {% if issue.details.issue %}
                                                {{ issue.details.issue }}
                                            {% else %}
                                                {{ issue.details }}
                                            {% endif %}
                                        </div>
                                        {% if issue.details.value %}
                                            <div class="text-muted mt-1">
                                                <strong>Value:</strong> {{ issue.details.value }}
                                            </div>
                                        {% endif %}
                                        {% if issue.details.element_type %}
                                            <div class="text-muted">
                                                <strong>Element:</strong> {{ issue.details.element_type }}
                                            </div>
                                        {% endif %}
                                        {% if issue.details.page_type %}
                                            <div class="text-muted">
                                                <strong>Page Type:</strong> {{ issue.details.page_type }}
                                            </div>
                                        {% endif %}
                                        {% if issue.details.directive %}
                                            <div class="text-muted">
                                                <strong>Directive:</strong> {{ issue.details.directive }}
                                            </div>
                                        {% endif %}
                                        {% if issue.details.user_agent %}
                                            <div class="text-muted">
                                                <strong>User Agent:</strong> {{ issue.details.user_agent }}
                                            </div>
                                        {% endif %}
                                        {% if issue.details.details %}
                                            <div class="text-muted mt-1">
                                                {% for key, value in issue.details.details.items %}
                                                    <div><strong>{{ key|title }}:</strong> {{ value }}</div>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                        <div class="text-muted mt-1">
                                            <small>Found: {{ issue.discovered_at|date:"M d, Y H:i" }}</small>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% include 'includes/footer.html' %}
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'assets/js/plugins/chartjs.min.js' %}"></script>
<script src="{% static 'assets/js/plugins/datatables.js' %}"></script>

<script>
// Initialize DataTable
const dataTableSearch = new simpleDatatables.DataTable("#issues-table", {
    searchable: true,
    fixedHeight: true,
    perPage: 25,
    pageLength: [25, 50, 100, 200]
});

// Severity Chart
const severityCtx = document.getElementById('severityChart').getContext('2d');
new Chart(severityCtx, {
    type: 'pie',
    data: {
        labels: {{ severity_data.labels|safe }},
        datasets: [{
            data: {{ severity_data.values|safe }},
            backgroundColor: [
                '#dc3545',  // Critical - Red
                '#ffc107',  // High - Yellow
                '#17a2b8',  // Medium - Info Blue
                '#28a745'   // Low - Green
            ]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'right',
                labels: {
                    boxWidth: 12
                }
            }
        }
    }
});

// Issue Type Chart
const issueTypeCtx = document.getElementById('issueTypeChart').getContext('2d');
new Chart(issueTypeCtx, {
    type: 'bar',
    data: {
        labels: {{ issue_type_data.labels|safe }},
        datasets: [{
            data: {{ issue_type_data.values|safe }},
            backgroundColor: '#007bff'
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        },
        plugins: {
            legend: {
                display: false
            }
        }
    }
});
</script>
{% endblock %} 